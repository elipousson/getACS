#' gt table function parameter definitions
#'
#' @param gt_object A gt object.
#' @name gt_params
#' @keywords internal
NULL

#' Add a Census data source note to a gt table
#'
#' [tab_acs_source()] adds a source note to a gt table using
#' [acs_survey_label_tables()] and [gt::tab_source_note()].
#'
#' @inheritParams gt_params
#' @inheritParams gt::tab_source_note
#' @inheritParams acs_survey_label_tables
#' @param append_note If `TRUE`, add source_note to the end of the generated ACS
#'   data label. If `FALSE`, any supplied source_note will be used instead of an
#'   ACS label.
#' @param use_md If `TRUE`, pass source_note to [gt::md()] first.
#' @param ... For [tab_acs_source()], additional parameters passed to
#'   [acs_survey_label_tables()]. For [cols_merge_uncert_ext()], additional
#'   parameters passed to [gt::cols_merge_uncert()]. For [fmt_acs_percent()],
#'   additional parameters passed to [gt::fmt_percent()].
#' @family gt table
#' @export
#' @importFrom glue glue
tab_acs_source <- function(gt_object,
                           source_note = NULL,
                           survey = "acs5",
                           year = 2021,
                           prefix = "Source: ",
                           before = "",
                           after = ".",
                           tables = NULL,
                           table_label = "Table",
                           append_note = FALSE,
                           use_md = FALSE,
                           ...) {
  check_installed("gt")

  if (append_note) {
    after <- after %||% ""
    after <- paste(after, source_note)
    source_note <- NULL
  }

  source_note <- source_note %||% acs_survey_label_tables(
    survey = survey,
    year = year,
    prefix = prefix,
    tables = tables,
    table_label = table_label,
    before = before,
    after = after,
    ...
  )

  if (use_md) {
    source_note <- gt::md(source_note)
  }

  if (identical(source_note, "")) {
    return(gt_object)
  }

  gt::tab_source_note(
    gt_object,
    source_note = source_note
  )
}

#' Merge columns to a value-with-uncertainty column
#'
#' [cols_merge_uncert_ext()] is a variant of [gt::cols_merge_uncert()] to
#' support col_val and col_uncert to be set based on a length 2 cols parameter
#' and optionally apply a prefix or postfix value. These options are primarily
#' for internal use by [gt_census_cols()], [fmt_acs_estimate()], and
#' [fmt_acs_percent()].
#'
#' @name cols_merge_uncert_ext
#' @inheritParams gt_params
#' @inheritParams gt::cols_merge_uncert
#' @param columns description
#' @param prefix,postfix Optional strings to insert before and/or after both
#'   col_val and col_uncert. Use a length 2 string `c("", "uncert_prefix")` if
#'   you want to apply a prefix to only one or the other column specification.
#' @inheritParams stringr::str_c
#' @family gt table
#' @export
#' @importFrom stringr str_c
cols_merge_uncert_ext <- function(gt_object,
                                  columns = NULL,
                                  col_val = NULL,
                                  col_uncert = NULL,
                                  prefix = "",
                                  postfix = "",
                                  sep = "",
                                  ...) {
  check_installed("gt")

  columns <- columns %||% c(col_val, col_uncert)

  stopifnot(all(is.character(columns)))

  columns <- stringr::str_c(prefix, columns, postfix, sep = sep)

  if (!has_length(columns, 2)) {
    cli_abort(
      "{.fn cols_merge_uncert_ext} requires {.arg columns} be
      a length 2 character vector."
    )
  }

  if (!all(has_name(gt_object[["_data"]], columns))) {
    return(gt_object)
  }

  gt::cols_merge_uncert(
    gt_object,
    col_val = columns[[1]],
    col_uncert = columns[[2]],
    ...
  )
}

#' Format estimate and margin of error columns (or % estimate and % margin of
#' error columns) in a gt table
#'
#' [fmt_acs_estimate()] formats estimate and margin of error columns for a gt
#' table. Used by [gt_census_cols()]
#'
#' @inheritParams gt_params
#' @param col_est,col_moe Column names for the estimate and margin of error
#'   values in the table data.
#' @param col_labels Column name used for one or more columns passed to
#'   [cols_label_ext()]
#' @param columns If `NULL` (default), columns is set to `c(col_est, col_moe)`.
#'   If spanner is `NULL`, columns is passed to [cols_merge_uncert_ext()] and
#'   must be a length 2 character vector.
#' @param spanner If `NULL`, gt table is passed to [cols_merge_uncert_ext()]. If
#'   not `NULL`, spanner is passed to the label parameter of [gt::tab_spanner()].
#' @inheritParams gt::fmt_number
#' @param ... Additional parameters passed to [gt::fmt_number()] by
#'   [fmt_acs_estimate()] or to [gt::fmt_percent()] by [fmt_acs_percent()].
#' @family gt table
#' @export
fmt_acs_estimate <- function(gt_object,
                             col_est = "estimate",
                             col_moe = "moe",
                             columns = NULL,
                             col_labels = "Est.",
                             spanner = NULL,
                             decimals = 0,
                             use_seps = TRUE,
                             ...) {
  check_installed("gt")

  columns <- columns %||% c(col_est, col_moe)

  gt_object <- cols_label_ext(
    gt_object,
    columns = columns,
    col_labels = col_labels
  )

  gt_object <- gt::fmt_number(
    gt_object,
    columns = any_of(columns),
    decimals = decimals,
    use_seps = use_seps,
    ...
  )

  if (is.null(spanner)) {
    return(cols_merge_uncert_ext(gt_object, columns = columns))
  }

  gt::tab_spanner(gt_object, spanner, columns = columns)
}

#' @rdname fmt_acs_estimate
#' @name fmt_acs_percent
#' @export
fmt_acs_percent <- function(gt_object,
                            col_est = "perc_estimate",
                            col_moe = "perc_moe",
                            columns = NULL,
                            col_labels = "% share",
                            spanner = NULL,
                            decimals = 0,
                            use_seps = TRUE,
                            ...) {
  check_installed("gt")

  columns <- columns %||% c(col_est, col_moe)

  gt_object <- cols_label_ext(gt_object, columns, col_labels)

  gt_object <- gt::fmt_percent(
    gt_object,
    columns = any_of(columns),
    decimals = decimals,
    use_seps = use_seps,
    ...
  )

  if (is.null(spanner)) {
    return(cols_merge_uncert_ext(gt_object, columns))
  }

  check_character(spanner)

  gt::tab_spanner(
    gt_object,
    label = spanner,
    columns = columns
    )
}

#' @rdname fmt_acs_estimate
#' @name cols_label_ext
#' @details Using cols_label_ext
#' [cols_label_ext()] is a variant on [gt::cols_label()] used by
#' [fmt_acs_estimate()] and [fmt_acs_percent()].
#' @export
cols_label_ext <- function(gt_object, columns, col_labels = NULL) {
  check_installed("gt")

  if (is.null(col_labels)) {
    return(gt_object)
  }

  stopifnot(
    all(is.character(columns))
  )

  if (has_length(col_labels, 1)) {
    col_labels <- set_names(col_labels, columns[[1]])
  } else {
    col_labels <- set_names(col_labels, columns)
  }

  gt::cols_label(
    gt_object,
    .list = col_labels
  )
}

#' Format American Community Survey estimate and percent estimate columns for a
#' gt table
#'
#' Create or format a gt table with an estimate and margin of error and
#' (optionally) percent estimate and margin of error value.
#'
#' @param gt_object If gt_object is a data frame, it is converted to a gt table
#'   with [gt::gt()].
#' @param est_cols,est_col_label,est_spanner Passed to columns, col_labels, and
#'   spanner parameter for [fmt_acs_estimate()]
#' @param perc_cols,perc_col_label,perc_spanner Passed to columns, col_labels,
#'   and spanner parameter for [fmt_acs_percent()]
#' @inheritParams fmt_acs_estimate
#' @param column_title_col Column name to check for in the input gt table. This
#'   parameter may not be needed so may be removed.
#' @param combined_spanner If not `NULL`, combined_spanner is passed to label
#'   parameter of [gt::tab_spanner()] using both est_cols and perc_cols as the
#'   columns parameter.
#' @inheritParams tab_acs_source
#' @family gt table
#' @export
gt_census_cols <- function(gt_object,
                           est_cols = c("estimate", "moe"),
                           est_col_label = "Est.",
                           perc_cols = c("perc_estimate", "perc_moe"),
                           perc_col_label = "% share",
                           est_spanner = NULL,
                           perc_spanner = NULL,
                           combined_spanner = NULL,
                           source_note = NULL,
                           survey = "acs5",
                           year = 2021,
                           prefix = "Source: ",
                           before = "",
                           after = ".",
                           tables = NULL,
                           decimals = 0,
                           column_title_col = "column_title",
                           ...) {
  check_installed("gt")

  if (is.data.frame(gt_object)) {
    gt_object <- gt::gt(gt_object, ...)
  }

  stopifnot(
    has_name(gt_object[["_data"]], column_title_col)
  )

  if (!is.null(est_cols)) {
    gt_object <- fmt_acs_estimate(
      gt_object,
      columns = est_cols,
      col_labels = est_col_label,
      decimals = decimals,
      spanner = est_spanner
    )
  }

  if (!is.null(perc_cols)) {
    gt_object <- fmt_acs_percent(
      gt_object,
      columns = perc_cols,
      col_labels = perc_col_label,
      decimals = decimals,
      spanner = perc_spanner
    )
  }

  if (!is_null(combined_spanner)) {
    gt_object <- gt::tab_spanner(
      gt_object,
      label = combined_spanner,
      columns = any_of(c(est_cols, perc_cols))
    )
  }

  tab_acs_source(
    gt_object = gt_object,
    source_note = source_note,
    survey = survey,
    year = year,
    prefix = prefix,
    before = before,
    after = after,
    tables = tables
  )
}
